<?xml version='1.0' encoding='UTF-8'?>

<project>
    <target name="dita2ia-webhelp-responsive-ab"
            depends="dita2custom-webhelp-resp.init,
                build-init,
                dita2custom-webhelp-resp.copy,
                dita2check-condition-contain,
                dita2use-template-ab,
                dita2transform-input-file,
                dita2go.to.top.btn,
                dita2custom-mainbooktitle,
                dita2custom-favicon,
                dita2webhelp-responsive"/>
                <!--dita2image-path,
                dita2ant-contrib-foreach-task,
                dita2copy-ditamap-with-new-images"/>-->
    <taskdef
            classpath="${dita.plugin.com.ia-trainee-task-ab.dir}/lib/ant-contrib.jar"
            resource="net/sf/antcontrib/antlib.xml"/>

    <target name="dita2image-path">
        <xslt in="${args.input}"
              out="${output.dir}/images-list.txt"
              style="${dita.plugin.com.ia-trainee-task-ab.dir}/xsl/image-task.xsl">
            <xmlcatalog refid="dita.catalog"/>
        </xslt>
    </target>

    <target name="dita2ant-contrib-foreach-task">
        <property name="path-changes-list" location="${output.dir}/images-list.txt"/>
        <loadfile property="path-changes-list-file" srcfile="${path-changes-list}"/>
        <foreach list="${path-changes-list-file}" target="dita2copy-images" param="image-file-name"
                 delimiter="'&#10;'"/>
    </target>

    <target name="dita2copy-images">
        <propertyregex property="path-to-images" input="${image-file-name}"
                       regexp="^(.+?);(.+?)$"
                       select="\1" />
        <propertyregex property="new-image-name" input="${image-file-name}"
                       regexp="^(.+?);(.+?)$"
                       select="\2" />
        <copy file="${path-to-images}" tofile="${output.dir}/${new-image-name}"/>
    </target>

    <target name="dita2copy-ditamap-with-new-images">
        <script language="javascript"><![CDATA[
            var File = java.io.File;
            var FileReader = java.io.FileReader;
            var BufferedReader = java.io.BufferedReader;
            var FileWriter = java.io.FileWriter;
            var inputFile = project.getProperty("args.input");
            var outputFile = inputFile.substring(inputFile.lastIndexOf('/')+1);
            project.setUserProperty("args.output", outputFile);
            ]]>
        </script>
        <xslt in="${args.input}"
              out="${output.dir}/${args.output}"
              style="${dita.plugin.com.ia-trainee-task-ab.dir}/xsl/image-changes.xsl">
            <xmlcatalog refid="dita.catalog"/>
            <param name="imagesList" expression="${path-changes-list-file}"/>
        </xslt>
    </target>

<!--  Webhelp tasks  -->
    <target name="dita2custom-webhelp-resp.init">
        <property name="args.css.file" value="css/custom.css"/>
    </target>

    <target name="dita2custom-webhelp-resp.copy">
        <copy todir="${output.dir}/css">
            <fileset dir="${dita.plugin.com.ia-trainee-task-ab.dir}/css"/>
        </copy>
    </target>

    <target name="dita2check-condition-contain">
        <condition property="contains" value="user">
            <contains string="${args.input}" substring="user1"/>
        </condition>
        <condition property="contains" value="IdeaProjects">
            <contains string="${args.input}" substring="IdeaProjects"/>
        </condition>
        <property name="contains" value="default"/>
    </target>

    <condition property="check-transtype">
        <equals arg1="${transtype}" arg2="ia-webhelp-responsive-ab" trim="true"/>
    </condition>

    <target name="dita2use-template-ab" if="check-transtype">
        <property name="webhelp.publishing.template"
                  value="${dita.plugin.com.ia-trainee-task-ab.dir}/templates/custom-template/custom-template-tree.opt"/>
        <property name="webhelp.template.index.terms.file"
                  value="${dita.plugin.com.ia-trainee-task-ab.dir}/page-templates/my-wt_terms.html"/>
        <property name="webhelp.fragment.footer"
                  value="${dita.plugin.com.ia-trainee-task-ab.dir}/my-footer.xml"/>
    </target>

    <target name="dita2transform-input-file">
        <script language="javascript"><![CDATA[
            var File = java.io.File;
            var FileReader = java.io.FileReader;
            var BufferedReader = java.io.BufferedReader;
            var FileWriter = java.io.FileWriter;
            var inputFile = project.getProperty("args.input");
            var inputDir = inputFile.substr(0, inputFile.lastIndexOf('/'));
            project.setUserProperty("args.input.dir", inputDir);
            ]]>
        </script>
        <xslt in="${args.input}"
              out="${args.input.dir}/reverse-book.ditamap"
              style="${dita.plugin.com.ia-trainee-task-ab.dir}/xsl/modify-ditamap.xsl">
            <xmlcatalog refid="dita.catalog"/>
        </xslt>
        <script language="javascript"><![CDATA[
            var File = java.io.File;
            var FileReader = java.io.FileReader;
            var BufferedReader = java.io.BufferedReader;
            var FileWriter = java.io.FileWriter;
            var inputDir = project.getProperty("args.input.dir");
            var newInputFile = inputDir.concat('/reverse-book.ditamap')
            project.setUserProperty("args.input", newInputFile);
            ]]>
        </script>
    </target>

    <target name="dita2go.to.top.btn">
        <copy todir="${output.dir}/js">
            <fileset dir="${dita.plugin.com.ia-trainee-task-ab.dir}/js"/>
        </copy>
        <property name="webhelp.fragment.after.body"
                  value="${dita.plugin.com.ia-trainee-task-ab.dir}/go2top-btn.xml"/>
    </target>

    <target name="dita2custom-mainbooktitle">
        <property name="webhelp.logo.image"
                  value="${dita.plugin.com.ia-trainee-task-ab.dir}/css/images/intelliarts-logo.svg"/>
        <property name="webhelp.logo.image.target.url"
                  value="https://intelliarts.com"/>
    </target>

    <target name="dita2custom-favicon">
        <property name="webhelp.favicon"
                  value="${dita.plugin.com.ia-trainee-task-ab.dir}/css/images/favicon.png"/>
    </target>

</project>